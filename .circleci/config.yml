version: 2.1
jobs:
  build:
    docker:    
      - image: cimg/python:3.9
        environment:
          PACKER_VER: 1.10.1
    resource_class: large
    steps:
      - run:
          name: Install unzip
          command: sudo apt-get install -y unzip
      - checkout
      - run:
          name: Install packer
          command: |
            python --version
            curl -L -o /tmp/packer-${PACKER_VER}.zip https://releases.hashicorp.com/packer/${PACKER_VER}/packer_${PACKER_VER}_linux_amd64.zip
            unzip /tmp/packer-${PACKER_VER}.zip -d /tmp/packer
            sudo mv /tmp/packer/* /usr/local/
      - run:
          name: install packer ansible plugin
          command: /usr/local/packer plugins install github.com/hashicorp/ansible
      - run:
          name: install packer aws plugin
          command: /usr/local/packer plugins install github.com/hashicorp/amazon
      - run:
          name: apt-get Update
          command: sudo apt-get update
      - run:
          name: Install software-properties-common
          command: sudo apt-get install software-properties-common
      - run:
          name: install ansible apt-get repo
          command: sudo apt-add-repository --yes ppa:ansible/ansible
      - run:
          name: Install Ansible
          command: sudo apt-get install ansible
      - run:
          name: check ansible version
          command: ansible-playbook --version
      - run:
          name: Validate dcc-hub aws packer ami config (built on ubuntu/debian)
          command: /usr/local/packer validate -var "ami_name=dcc-hub"  -var "hub_personality=dcc" -var "source_ami_name=ami-003932de22c285676" -var "source_ami_owner=099720109477" -var "AWSKEY=${aws_access_key_id}" -var "AWSSECRET=${aws_secret_access_key}" build-dcc-hub-ec2-ami.json
      - run:
          name: Build dcc-hub aws packer ami config (built on ubuntu/debian)
          command: /usr/local/packer build -var "ami_name=dcc-hub"  -var "hub_personality=dcc" -var "source_ami_name=ami-003932de22c285676" -var "source_ami_owner=099720109477" -var "AWSKEY=${aws_access_key_id}" -var "AWSSECRET=${aws_secret_access_key}" build-dcc-hub-ec2-ami.json
      - run:
          name: Validate ida-nrts-hub aws packer ami config
          command: /usr/local/packer validate -var "ami_name=ida-nrts-hub" -var "hub_personality=nrts" -var "AWSKEY=${aws_access_key_id}" -var "AWSSECRET=${aws_secret_access_key}" build-nrts-hub-ec2-ami.json
      - run:
          name: Build ida-nrts-hub with aws packer ami image
          command: /usr/local/packer build -var "ami_name=ida-nrts-hub" -var "hub_personality=nrts" -var "AWSKEY=${aws_access_key_id}" -var "AWSSECRET=${aws_secret_access_key}" build-nrts-hub-ec2-ami.json 
    #   - run:
    #       name: Validate gci-hub aws packer ami config
    #       command: /usr/local/packer validate -var "ami_name=gci-hub" -var "hub_personality=nrts" -var "source_ami_name=ida-nrts-hub" -var "source_ami_owner=863634277693" -var "AWSKEY=${aws_access_key_id}" -var "AWSSECRET=${aws_secret_access_key}" build-gci-hub-ec2-ami.json
    #   - run:
    #       name: Build gci-hub with aws packer ami image
    #       command: /usr/local/packer build -var "ami_name=gci-hub" -var "hub_personality=nrts" -var "source_ami_name=ida-nrts-hub" -var "source_ami_owner=863634277693" -var "AWSKEY=${aws_access_key_id}" -var "AWSSECRET=${aws_secret_access_key}" build-gci-hub-ec2-ami.json 



